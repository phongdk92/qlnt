{% extends "base.html" %}

{% block content %}
    <script>

        $(document).ready(function() {

            $(".rightInfoDiv").hide();
            $(".startYear").hide();
            $(".confirmation").hide();


            var update_school_detail_done = function(json) {
                if (json.status == 'done') {
                    $("#headTitle").text($("#id_name").val());
                    $(".leftInfoDiv").hide();
                    $(".message").text('');
                    $(".rightInfoDiv").show(500);
                } else {
                }
            };

            $("#update_school_detail").click(function() {
                var school_name = $("#id_name").val();
                var school_level = $("#id_school_level").val();
                var school_address = $("#id_address").val();
                var school_phone = $("#id_phone").val();
                var school_email = $("#id_email").val();
                var data = { name: school_name, school_level: school_level,
                    address: school_address, phone: school_phone, email: school_email,
                    update_school_detail: true };

                if ( school_email.indexOf('@') == -1 || school_email.indexOf('.')==-1 ){
                    $("notify").showNotification('Email bạn vừa nhập không tồn tại.');
                } else {
                    var para = {
                        type:"POST",
                        url:"",
                        data: data,
                        datatype: "json",
                        success: update_school_detail_done
                    };
                    $.ajax(para);
                }
                return false;
            });

            var update_class_name_done = function(json) {
                if (json.status) {
                    $("#message").text('');
                    var grades = json.grades.split('-');
                    var labels = json.labels.split('-');
                    var text = '';
                    for ( var i =0; i < grades.length; i++){
                        text += '<div style="float: left; margin: 15px;"><ul>'
                        for ( var j=0; j< labels.length; j++)
                            text = text + '<li>' + grades[i] + ' ' + labels[j] + '</li>'
                        text += '</ul></div>';
                    }
                    text +='<div style="clear: both;"></div>'
                    $("#classReview").html(text);
                    $(".rightInfoDiv").hide();
                    $(".confirmation").fadeIn(300);
                } else {
                    $("#notify").showNotification(json.message);
                }
            };

            $("#update_class_name").click(function(){
                var labels = $("#labels").val();
                var temp = labels.replace(/Nhanh/g,'').replace(/nhanh/g,'').replace(/:/g,'');
                temp = temp.replace(/ /g,'');
                if (labels.indexOf('-') != -1){
                    $("#notify").showNotification('Tên lớp không được chứa kí tự "-".');
                } else if ( temp.length == 0){
                    $("#notify").showNotification('Danh sách lớp học để trống.');
                }
                else {
                    $("#labels").attr('readonly', 'readonly');
                    $(this).attr('disabled','disabled');


                    var data = { labels: labels,
                        update_class_name: true};
                    var para = {
                        type:"POST",
                        url:"",
                        data: data,
                        datatype: "json",
                        success: update_class_name_done
                    };
                    $.ajax(para);
                }
                return false;
            });

            $("#confirmation_ok").click(function() {
                $(".rightInfoDiv").hide();
                $(".confirmation").hide();
                $(".startYear").fadeIn(500);
                return false;
            });

            $("#confirmation_cancel").click(function(){
                $(".confirmation").fadeOut(200);
                $("#labels").removeAttr('readonly');
                $("#update_class_name").removeAttr('disabled');
                $(".rightInfoDiv").fadeIn(300);
                return false;
            });

            var start_year_done = function(json) {
                if (json.status == 'done') {
                    window.location.href = "{%url school.views.b1 %}"
                } else {
                    window.location.href = "{%url school.views.setup %}"
                }
            }

            $("#start_year").click(function() {
                var data = { start_year: true };
                var para = {
                    type:"POST",
                    url:"",
                    data: data,
                    datatype: "json",
                    success: start_year_done
                };
                $.ajax(para);
                return false;
            });
        });
    </script>


    <h2>Thiết lập thông tin cho trường học</h2>
    <p id="message">
        {% if message != None %}
            {{ message }}
            <br/>
        {% endif %}
    </p>
    {% if user.userprofile.position == 'HIEU_TRUONG' or user.userprofile.position == 'HIEU_PHO' %}

        <form action="{%url school.views.setup %}" method="post">{% csrf_token %}
            <div class="infoContent">
                <div class="leftInfoDiv">
                    <table class="styleA">
                        {{ form.as_table }}
                    </table>

                    <input class="ggButton" type="submit" name="submit" id="update_school_detail" value="Tiếp tục"/>

                </div>

                <div class="rightInfoDiv">
                    <div class="rightInfoDivMain">
                        <p>Nhập tên các lớp cách nhau bởi dấu phảy.</p>

                        <p>-Bạn có thể lần lượt nhập tên các lớp học theo dạng [Khối][Dấu cách][Tên lớp],</p>

                        <p> các lớp cách nhau một dấu phảy (,). Ví dụ: 10 A, 10 B, 10 C ...</p>

                        <p>-Hoặc nhập nhanh tên các lớp bằng cách thêm chuỗi "Nhanh:" vào trước, sau đó</p>

                        <p> gõ tên các lớp cách nhau bằng dấu phảy (,).</p>

                        <p> Ví dụ: "Nhanh: A, B" để tạo lớp 10 A, 10 B, 11 A, 11 B, 12 A, 12 B</p>
                        <br>
                        <input type="text" name="labels" id="labels" style="width: 400px;" value="{{labels}}"/>
                    </div>
                    <br>
                    <input class="ggButton" type="submit" name="submit" id="update_class_name" value="Tiếp tục"/>
                </div>
                <div class="confirmation" style="margin: 25px; float: left;">
                    <p>Bạn có muốn tạo các lớp dưới đây không?</p>
                    <div id="classReview"></div>
                    <br>
                    <input class="ggButton" type="submit" id="confirmation_ok" value="Đồng ý">
                    <input class="ggButton" type="submit" id="confirmation_cancel" value="Quay lại">
                </div>
                <div class="startYear">
                    <p>Hãy ấn "Bắt đầu năm học" để kết thúc quá trình nhập thông tin cho trường học</p>
                    <br>
                    <br>
                    <input class="ggButton" type="submit" name="start_year" id="start_year" value="Bắt đầu năm học"/>
                </div>
            </div>
        </form>
    {% endif %}
{% endblock %}
